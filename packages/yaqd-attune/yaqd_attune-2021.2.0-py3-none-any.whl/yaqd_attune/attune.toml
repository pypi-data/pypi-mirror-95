protocol = "attune"
doc="yaq daemon representing an attune instrument"
traits=["has-limits", "is-homeable", "is-daemon"]

[links]
source = "https://gitlab.com/yaq/yaqd-attune"
bugtracker = "https://gitlab.com/yaq/yaqd-attune/-/issues"

[installation]
PyPI = "https://pypi.org/project/yaqd-attune"

[[types]]
type="record"
name="Transition"
fields=[{name="type", type="string"}]

[[types]]
type="record"
name="Setable"
fields=[{name="name", type="string"}]

[[types]]
type="record"
name="Tune"
[[types.fields]]
name="independent"
type={type="array", items="float"}
[[types.fields]]
name="dependent"
type={type="array", items="float"}


[[types]]
type="record"
name="Arrangement"
[[types.fields]]
name="name"
type="string"
[[types.fields]]
name="tunes"
type={type="map", values="Tune"}

[[types]]
type="record"
name="Instrument"
[[types.fields]]
name="name"
type="string"
[[types.fields]]
name="arrangements"
type={type="map", values="Arrangement"}
[[types.fields]]
name="setables"
type={type="map", values="Setable"}
[[types.fields]]
name="transition"
type="Transition"

[config]
setables.type = "map"
setables.values = "int"
setables.doc = "mapping of setable names (must be a superset of those in the instrument) to yaq ports"

[state]
arrangement.type=["null", "string"]
arrangement.default="__null__"
arrangement.doc = "Currently selected arrangement. If null, use whichever arrangment fits the requested position, and error if there are multiple"

[messages]

[messages.get_instrument]
response = "Instrument"
doc = "Get the currently in use instrument object"

[messages.set_instrument]
request = [{name="instrument", type="Instrument"}]
doc = "Set the currently in use instrument object. Also triggers a restart"

[messages.get_arrangement]
response = "string"
doc = "Get the currently in use arrangement name"

[messages.get_all_arrangements]
response = {type="array", items="string"}
doc = "Get all currently valid arrangement names"

[messages.set_arrangement]
request = [{name="arrangement", type="string"}]
doc = "Get the currently in use arrangement name"

[messages.set_position_except]
doc = "Set the position, but ignore some setables"
[[messages.set_position_except.request]]
name="position"
type="float"
[[messages.set_position_except.request]]
name="exceptions"
type={type="array", items="string"}

[messages.get_setable_yaq_params]
response = {type="map", values="int"}
doc = "Get the ports for setables."

[messages.get_setable_names]
response = {type="array", items="string"}
doc = "Get list of setables"

[messages.set_setable_positions]
doc = "Set underlying setables, accepts a mapping of names to positions, in native units."
[[messages.set_setable_positions.request]]
name="setables"
type={type="map", values="float"}


[messages.get_setable_positions]
response = {type="map", values="float"}
doc = "Get underlying setables, provides a mapping of names to positions, in native units."

[messages.home_setables]
doc = "Home underlying setables, accepts a list of names to home."
[[messages.home_setables.request]]
name = "setables"
type = {type="array", items="string"}


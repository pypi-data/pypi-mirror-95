!function(e){"use strict";function t(e){return e.nodeType===Node.ELEMENT_NODE}const n=["A","ABBR","ACRONYM","AUDIO","B","BDI","BDO","BIG","BR","BUTTON","CANVAS","CITE","CODE","DATA","DATALIST","DEL","DFN","EM","EMBED","I","IFRAME","IMG","INPUT","INS","KBD","LABEL","MAP","MARK","METER","NOSCRIPT","OBJECT","OUTPUT","PICTURE","PROGRESS","Q","RUBY","S","SAMP","SCRIPT","SELECT","SLOT","SMALL","SPAN","STRONG","SUB","SUP","SVG","TEMPLATE","TEXTAREA","TIME","U","TT","VAR","VIDEO","WBR"];function i(e,t){window.bridgeCommand(e,t)}let o=null;function s(){return o}function r(){const e=["bold","italic","underline","superscript","subscript"];for(const t of e){document.querySelector(`#${t}`).classList.toggle("highlighted",document.queryCommandState(t))}}function l(){$("button.linkb:not(.perm)").prop("disabled",!0)}function c(){$("button.linkb").prop("disabled",!1)}let d=null;function a(e){u(),d=setTimeout((function(){r(),f(e,"key")}),600)}function u(){d&&(clearTimeout(d),d=null)}function f(e,t){u(),i(`${t}:${e.ord}:${s()}:${e.fieldHTML}`)}let m={},h={},E=["P","DIV","BR","SUB","SUP"];for(const e of E)m[e]={attrs:[]};E=["B","BLOCKQUOTE","CODE","DD","DL","DT","EM","H1","H2","H3","I","LI","OL","PRE","RP","RT","RUBY","STRONG","TABLE","U","UL"];for(const e of E)h[e]={attrs:[]};m.IMG={attrs:["SRC"]},h.A={attrs:["HREF"]},h.TR={attrs:["ROWSPAN"]},h.TD={attrs:["COLSPAN","ROWSPAN"]},h.TH={attrs:["COLSPAN","ROWSPAN"]},h.FONT={attrs:["COLOR"]};const g={color:!0,"background-color":!0,"font-weight":!0,"font-style":!0,"text-decoration-line":!0};h.SPAN=function(e){for(const t of[...e.attributes]){"STYLE"!==t.name.toUpperCase()&&e.removeAttributeNode(t)}for(const t of[...e.style]){const n=e.style.getPropertyValue(t);(!g.hasOwnProperty(t)||"background-color"===t&&"transparent"===n||document.body.classList.contains("nightMode")&&("background-color"===t||"color"===t))&&e.style.removeProperty(t)}},Object.assign(h,m);let p=function(e){(function(e){return e instanceof HTMLElement})(e)&&(e.style.removeProperty("background-color"),e.style.removeProperty("font-size"),e.style.removeProperty("font-family"));for(let t=0;t<e.children.length;t++){const n=e.children[t];p(n)}},b=function(e,n){if(!t(e))return;for(const t of[...e.children])b(t,n);if("ANKITOP"===e.tagName)return;const i=n?h[e.tagName]:m[e.tagName];if(i)if("function"==typeof i)i(e);else for(const t of[...e.attributes]){const n=t.name.toUpperCase();-1===i.attrs.indexOf(n)&&e.removeAttributeNode(t)}else e.innerHTML&&"TITLE"!==e.tagName?e.outerHTML=e.innerHTML:e.parentNode.removeChild(e)};function T(e){a(e.currentTarget)}function L(e){const n=e.currentTarget;if("Escape"!==e.code){if("Enter"!==e.code||function(e){const n=e.getSelection().anchorNode;let i=!1,o=t(n)?n:n.parentElement;for(;o;)i=i||"list-item"==window.getComputedStyle(o).display,o=o.parentElement;return i}(n)||(e.preventDefault(),document.execCommand("insertLineBreak")),n.isRightToLeft()){const t=n.getSelection(),i=e.ctrlKey?"word":"character",o=e.shiftKey?"extend":"move";switch(e.code){case"ArrowRight":return t.modify(o,"right",i),void e.preventDefault();case"ArrowLeft":return t.modify(o,"left",i),void e.preventDefault()}}a(n)}else n.blurEditable()}function y(e){const n=e.currentTarget;if("Enter"===e.code||"Backspace"===e.code){const e=n.getSelection().anchorNode;!t(e)||"DIV"!==e.tagName||e instanceof H||1!==e.childElementCount||"BR"!==e.children[0].tagName||e.replaceWith(e.children[0])}}var v;!function(e){e[e.Contained=0]="Contained",e[e.ExceedTop=1]="ExceedTop",e[e.ExceedBottom=2]="ExceedBottom"}(v||(v={}));let C=null;function A(e){const t=e.currentTarget;if(t===C)return;const n=t.parentElement,o=document.getElementById("topbutsOuter").clientHeight;switch(function(e,t){const n=e.getBoundingClientRect();return n.top<=t?v.ExceedTop:n.bottom>=(window.innerHeight||document.documentElement.clientHeight)?v.ExceedBottom:v.Contained}(n,o)){case v.ExceedBottom:n.scrollIntoView(!1);break;case v.ExceedTop:n.scrollIntoView(!0),window.scrollBy(0,-o)}t.focusEditable(),i(`focus:${t.ord}`),c(),function(e){const t=document.createRange();t.selectNodeContents(e.editable),t.collapse(!1);const n=e.getSelection();n.removeAllRanges(),n.addRange(t)}(t)}function S(e){const t=e.currentTarget;t===document.activeElement?(f(t,"key"),C=t):(f(t,"blur"),l(),C=null)}function R(e,t,n){const i=e.match(/^(\s*)([^]*?)(\s*)$/);return i[1]+t+i[2]+n+i[3]}function B(e,t,n){const i=N().getSelection(),o=i.getRangeAt(0).cloneContents(),s=document.createElement("span");if(s.appendChild(o),n){x("inserttext",R(s.innerText,e,t))}else{x("inserthtml",R(s.innerHTML,e,t))}s.innerHTML||function(e,t){const n=e.getRangeAt(0);n.setStart(n.startContainer,n.startOffset-t.length),n.collapse(!0),e.removeAllRanges(),e.addRange(n)}(i,t)}function N(){return document.activeElement instanceof H?document.activeElement:null}function M(e){i("paste"),e.preventDefault()}function k(){return i("cutOrCopy"),!0}function I(e){if(0===e.childNodes.length)return!1;for(const o of e.children)if(t(i=o)&&!n.includes(i.tagName))return!1;var i;return!0}class O extends HTMLElement{set fieldHTML(e){this.innerHTML=e,I(this)&&this.appendChild(document.createElement("br"))}get fieldHTML(){return I(this)&&this.innerHTML.endsWith("<br>")?this.innerHTML.slice(0,-4):this.innerHTML}connectedCallback(){this.setAttribute("contenteditable","")}}customElements.define("anki-editable",O);class H extends HTMLDivElement{constructor(){super(),this.attachShadow({mode:"open"}),this.className="field";const e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("href","./_anki/css/editable.css"),this.shadowRoot.appendChild(e),this.baseStyle=document.createElement("style"),this.baseStyle.setAttribute("rel","stylesheet"),this.shadowRoot.appendChild(this.baseStyle),this.editable=document.createElement("anki-editable"),this.shadowRoot.appendChild(this.editable)}get ord(){return Number(this.getAttribute("ord"))}set fieldHTML(e){this.editable.fieldHTML=e}get fieldHTML(){return this.editable.fieldHTML}connectedCallback(){this.addEventListener("keydown",L),this.addEventListener("keyup",y),this.addEventListener("input",T),this.addEventListener("focus",A),this.addEventListener("blur",S),this.addEventListener("paste",M),this.addEventListener("copy",k),this.addEventListener("oncut",k),this.addEventListener("mouseup",r);this.baseStyle.sheet.insertRule("anki-editable {}",0)}disconnectedCallback(){this.removeEventListener("keydown",L),this.removeEventListener("keyup",y),this.removeEventListener("input",T),this.removeEventListener("focus",A),this.removeEventListener("blur",S),this.removeEventListener("paste",M),this.removeEventListener("copy",k),this.removeEventListener("oncut",k),this.removeEventListener("mouseup",r)}initialize(e,t){this.setBaseColor(e),this.editable.fieldHTML=t}setBaseColor(e){this.baseStyle.sheet.cssRules[0].style.color=e}setBaseStyling(e,t,n){const i=this.baseStyle.sheet.cssRules[0];i.style.fontFamily=e,i.style.fontSize=t,i.style.direction=n}isRightToLeft(){return"rtl"===this.editable.style.direction}getSelection(){return this.shadowRoot.getSelection()}focusEditable(){this.editable.focus()}blurEditable(){this.editable.blur()}}customElements.define("anki-editing-area",H,{extends:"div"});class w extends HTMLDivElement{constructor(){super(),this.labelContainer=document.createElement("div"),this.labelContainer.className="fname",this.appendChild(this.labelContainer),this.label=document.createElement("span"),this.label.className="fieldname",this.labelContainer.appendChild(this.label),this.editingArea=document.createElement("div",{is:"anki-editing-area"}),this.appendChild(this.editingArea)}static get observedAttributes(){return["ord"]}set ord(e){this.setAttribute("ord",String(e))}attributeChangedCallback(e,t,n){switch(e){case"ord":this.editingArea.setAttribute("ord",n)}}initialize(e,t,n){this.label.innerText=e,this.editingArea.initialize(t,n)}setBaseStyling(e,t,n){this.editingArea.setBaseStyling(e,t,n)}}function P(e){var t;return null!==(t=document.getElementById("fields").children[e])&&void 0!==t?t:null}function D(e,t){const n=document.getElementById("fields").children;for(let i=0;i<n.length;i++){t(n[i],e[i])}}function x(e,t,n=!1){document.execCommand(e,!1,t),n||(f(N(),"key"),r())}customElements.define("anki-editor-field",w,{extends:"div"}),e.EditingArea=H,e.EditorField=w,e.focusField=function(e){const t=P(e);t&&t.editingArea.focusEditable()},e.focusIfField=function(e,t){const n=document.elementsFromPoint(e,t);for(let e=0;e<n.length;e++){let t=n[e];if(t instanceof H)return t.focusEditable(),!0}return!1},e.forEditorField=D,e.getCurrentField=N,e.getEditorField=P,e.getNoteId=s,e.pasteHTML=function(e,t,n){""!==(e=function(e,t,n){const i=document.createElement("ankitop");i.innerHTML=e,t?p(i):b(i,n);let o=i.innerHTML;return n||t||(o=o.replace(/[\n\t ]+/g," ")),o=o.trim(),o}(e,t,n))&&x("inserthtml",e)},e.preventButtonFocus=function(){for(const e of document.querySelectorAll("button.linkb"))e.addEventListener("mousedown",(e=>{e.preventDefault()}))},e.saveNow=function(e){const t=N();t&&(u(),e?f(t,"key"):t.blurEditable())},e.setBackgrounds=function(e){D(e,((e,t)=>e.editingArea.classList.toggle("dupe","dupe"===t))),document.getElementById("dupes").classList.toggle("is-inactive",!e.includes("dupe"))},e.setFGButton=function(e){document.getElementById("forecolor").style.backgroundColor=e},e.setFields=function(e){const t=window.getComputedStyle(document.documentElement).getPropertyValue("--text-fg");!function(e){const t=document.getElementById("fields");for(;t.childElementCount<e;){const e=document.createElement("div",{is:"anki-editor-field"});e.ord=t.childElementCount,t.appendChild(e)}for(;t.childElementCount>e;)t.removeChild(t.lastElementChild)}(e.length),D(e,((e,[n,i])=>e.initialize(n,t,i))),document.activeElement instanceof H?c():l()},e.setFonts=function(e){D(e,((e,[t,n,i])=>{e.setBaseStyling(t,`${n}px`,i?"rtl":"ltr")}))},e.setFormat=x,e.setNoteId=function(e){o=e},e.toggleEditorButton=function(e){$(e)[0].classList.toggle("highlighted")},e.wrap=function(e,t){B(e,t,!1)},e.wrapIntoText=function(e,t){B(e,t,!0)},Object.defineProperty(e,"__esModule",{value:!0})}(this.globalThis=this.globalThis||{});

{% extends 'psu_base.html' %}
{% load base_taglib %}

{%block title%}Scheduled Jobs{%endblock%}
{% block scripts %}{% endblock %}
{% block pagecontent %}

<h1>Scheduled Jobs</h1>

<table class="table table-condensed table-hover">
    <tr>
        <td>&nbsp;</td>
        <th scope="col">Job</th>
        <th scope="col">Performer</th>
        <th scope="col">Date Range</th>
        <th scope="col">Run Days</th>
        <th scope="col">Run Times</th>
        <th scope="col">Frequency</th>
        <th scope="col">Active</th>
    </tr>
{%for job in jobs%}
    <tr id="row-{{job.id}}">
        <td>
            <a href="{%url 'scheduler:executions'%}?schedule={{job.id}}" target="_blank">
                {%fa fa-history title="View execution history"%}
            </a>
        </td>
        <td>
            {{job.endpoint.title}}
            {%if is_developer%}
                <br />
                {{job.endpoint.endpoint.url}}
            {%endif%}
        </td>
        <td>
            {%if is_developer%}
                <input type="text" id="performer-{{job.id}}" value="{{job.performer|default:''}}" class="form-control" />
            {%else%}
                {%fa fa-user title="Performer"%} {{job.performer}}
                {%if job.performer != current_user.username%}
                    - assign to me -
                {%endif%}
            {%endif%}
        </td>
        <td>
            From {{job.start_date|default:job.date_created|date:"d-M-Y"|upper}}<br />
            <br />
            Until
            <input type="text" id="end_date-{{job.id}}" value="{{job.end_cd.timestamp|default:''}}" class="form-control" placeholder="Infinity" />
        </td>
        <td>
            <label><input type="checkbox" name="run_days" value="6" {%if '6' in job.run_days%}checked{%endif%} /> Sunday</label><br />
            <label><input type="checkbox" name="run_days" value="0" {%if '0' in job.run_days%}checked{%endif%} /> Monday</label><br />
            <label><input type="checkbox" name="run_days" value="1" {%if '1' in job.run_days%}checked{%endif%} /> Tuesday</label><br />
            <label><input type="checkbox" name="run_days" value="2" {%if '2' in job.run_days%}checked{%endif%} /> Wednesday</label><br />
            <label><input type="checkbox" name="run_days" value="3" {%if '3' in job.run_days%}checked{%endif%} /> Thursday</label><br />
            <label><input type="checkbox" name="run_days" value="4" {%if '4' in job.run_days%}checked{%endif%} /> Friday</label><br />
            <label><input type="checkbox" name="run_days" value="5" {%if '5' in job.run_days%}checked{%endif%} /> Saturday</label><br />
        </td>
        <td>
            {%if job.run_frequency%}
                {{job.run_time_range}}
            {%elif job.run_times_csv%}
                {%for tt in job.run_times_display%}
                    {{tt}},&nbsp;
                {%endfor%}
            {%endif%}
        </td>
        <td>
            {%if job.run_frequency%}
                Every {{job.run_frequency}} Minutes
            {%else%}
                At defined times
            {%endif%}
        </td>
        <td>

            {%if job.is_active%}
                <a href="{%url 'scheduler:toggle' job.id%}">{%fa fa-toggle-on fa-fw title="Job is active"%}</a>
            {%else%}
                <a href="{%url 'scheduler:toggle' job.id%}">{%fa fa-toggle-off fa-fw title="Job is inactive"%}</a>
            {%endif%}

            &nbsp;
            {%if is_developer%}
                <a href="{%url 'scheduler:delete_job' job.id%}">{%fa fa-trash-o fa-fw text-danger title="Job is active"%}</a>
            {%endif%}
        </td>
    </tr>
{%empty%}
    <tr>
        <td colspan="9">
            <em class="text-muted" style="text-align:center;">No Scheduled Jobs</em>
        </td>
    </tr>
{%endfor%}
</table>

<br />
<br />

{%if is_developer%}
    <button type="button" class="btn btn-info" onclick="$(this).addClass('hidden');$('#new-job-div').removeClass('hidden');$('#title').focus();">
        {%fa fa-plus%} New Job
    </button>
    <div class="hidden" id="new-job-div">
        <form method="post" action="{%url 'scheduler:save_job'%}">
            {%csrf_token%}
            <table class="table table-condensed">
                <tr>
                    <td>
                        {%select_menu name="endpoint" id="endpoint" class="form-control" options=endpoint_options null_label="Select a Job"%}
                        <label for="endpoint">Endpoint</label>
                    </td>
                    <td>
                        <input type="text" name="performer" id="performer" maxlength="30" class="form-control" />
                        <label for="performer">Performer</label>
                    </td>
                    <td>
                        <input type="date" name="start_date" id="start_date" class="form-control" />
                        <label for="start_date">Start Date</label>
                    </td>
                    <td>
                        <input type="date" name="end_date" id="end_date" class="form-control" />
                        <label for="end_date">End Date</label>
                    </td>
                    <td>
                        <label><input type="checkbox" name="run_days" value="6" /> Sunday</label><br />
                        <label><input type="checkbox" name="run_days" value="0" checked /> Monday</label><br />
                        <label><input type="checkbox" name="run_days" value="1" checked /> Tuesday</label><br />
                        <label><input type="checkbox" name="run_days" value="2" checked /> Wednesday</label><br />
                        <label><input type="checkbox" name="run_days" value="3" checked /> Thursday</label><br />
                        <label><input type="checkbox" name="run_days" value="4" checked /> Friday</label><br />
                        <label><input type="checkbox" name="run_days" value="5" /> Saturday</label><br />
                    </td>
                    <td>
                        <input type="text" name="run_times_csv" id="run_times" class="form-control" />
                        <label for="run_times">Run Times</label>
                    </td>
                    <td>
                        <input type="number" name="run_frequency" id="run_frequency" class="form-control" />
                        <label for="run_frequency">Run Frequency (minutes)</label>
                    </td>
                    <td>
                        <button type="submit" class="btn btn-success">Save</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>
{%endif%}

{% endblock %}